<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portal Karyawan - Absensi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <!-- Import Firebase Config -->
    <script type="module" src="firebase-config.js"></script>
    <script src="storage-firebase.js"></script>
    
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
        }
        body {
            overscroll-behavior: none;
        }
        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #3b82f6, transparent);
            animation: scan 2s linear infinite;
        }
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        /* Mobile specific */
        video {
            object-fit: cover;
        }
        canvas {
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50 p-4">
        <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-lg font-semibold text-gray-700 text-center" id="loadingText">Memuat sistem...</p>
        <p class="mt-2 text-sm text-gray-500 text-center" id="loadingStatus">Menginisialisasi...</p>
        <div class="mt-4 text-xs text-gray-400" id="deviceInfo"></div>
    </div>

    <!-- Main Container -->
    <div id="mainContent" class="hidden min-h-screen pb-20">
        
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 sticky top-0 z-10 shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl md:text-2xl font-bold">Portal Karyawan</h1>
                    <p class="text-xs md:text-sm text-blue-100 mt-1">Absensi Face Recognition</p>
                </div>
                <a href="index.html" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-3 py-2 rounded-lg text-sm transition">
                    üè† Home
                </a>
            </div>
            
            <!-- Status Bar -->
            <div class="mt-3 flex items-center justify-between text-xs md:text-sm">
                <div>
                    <span class="opacity-75">Waktu:</span>
                    <span class="font-semibold ml-1" id="currentTime">--:--</span>
                </div>
                <div>
                    <span class="opacity-75">Karyawan:</span>
                    <span class="font-semibold ml-1" id="totalEmployees">0</span>
                </div>
                <div id="systemStatus">üü¢</div>
            </div>
        </div>

        <!-- Camera Section -->
        <div class="p-4">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                
                <!-- Video Container - Optimized for Mobile -->
                <div class="relative bg-black" style="aspect-ratio: 4/3;">
                    <video id="video" autoplay playsinline muted 
                           class="w-full h-full object-cover hidden"></video>
                    <canvas id="overlay" class="absolute top-0 left-0 w-full h-full hidden"></canvas>
                    
                    <!-- Scanning Effect -->
                    <div id="scanEffect" class="scan-line hidden"></div>
                    
                    <!-- Camera Placeholder -->
                    <div id="cameraPlaceholder" class="absolute inset-0 flex items-center justify-center">
                        <div class="text-center text-white">
                            <div class="text-6xl mb-4">üìπ</div>
                            <p class="text-sm px-4">Tekan tombol di bawah untuk mulai scan wajah</p>
                        </div>
                    </div>

                    <!-- Detection Overlay -->
                    <div id="detectionOverlay" class="absolute inset-0 flex items-center justify-center hidden">
                        <div class="bg-black bg-opacity-75 text-white px-6 py-3 rounded-full">
                            <span id="detectionText">Scanning...</span>
                        </div>
                    </div>
                </div>

                <!-- Status Messages -->
                <div id="statusMessage" class="p-4 text-center hidden">
                    <p id="statusText" class="text-sm font-medium"></p>
                </div>

                <!-- Recognition Result -->
                <div id="recognitionResult" class="p-4 bg-gradient-to-r from-green-50 to-green-100 hidden">
                    <div class="text-center">
                        <div class="text-4xl mb-2">‚úÖ</div>
                        <p class="text-sm text-gray-600">Terdeteksi:</p>
                        <p class="text-xl font-bold text-gray-800" id="detectedName">-</p>
                        <p class="text-xs text-gray-500 mt-1">Confidence: <span id="confidence">0%</span></p>
                    </div>
                </div>

                <!-- Control Buttons -->
                <div class="p-4 space-y-2">
                    <button id="startBtn" class="w-full bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white py-4 rounded-lg font-semibold transition text-lg shadow-md">
                        üìπ Mulai Scan Wajah
                    </button>
                    
                    <div id="attendanceButtons" class="hidden space-y-2">
                        <button id="checkInBtn" class="w-full bg-green-500 hover:bg-green-600 active:bg-green-700 text-white py-4 rounded-lg font-semibold transition text-lg shadow-md">
                            ‚úÖ Absen Masuk
                        </button>
                        <button id="checkOutBtn" class="w-full bg-red-500 hover:bg-red-600 active:bg-red-700 text-white py-4 rounded-lg font-semibold transition text-lg shadow-md">
                            üö™ Absen Pulang
                        </button>
                    </div>
                    
                    <button id="stopBtn" class="w-full bg-gray-500 hover:bg-gray-600 active:bg-gray-700 text-white py-3 rounded-lg font-semibold transition hidden">
                        ‚èπÔ∏è Berhenti
                    </button>
                </div>
            </div>

            <!-- Recent Attendance -->
            <div class="bg-white rounded-xl shadow-lg p-4 mt-4">
                <h3 class="text-lg font-bold mb-3">Riwayat Hari Ini</h3>
                <div id="attendanceList" class="space-y-2">
                    <p class="text-gray-500 text-center py-4 text-sm">Memuat...</p>
                </div>
            </div>

            <!-- Debug Info (Hidden by default) -->
            <div id="debugPanel" class="bg-gray-100 rounded-xl shadow-lg p-4 mt-4 hidden">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-bold">üîß Debug Info</h3>
                    <button id="closeDebug" class="text-xs text-gray-500">Close</button>
                </div>
                <div id="debugLog" class="text-xs space-y-1 max-h-48 overflow-y-auto"></div>
            </div>
            
            <button id="toggleDebug" class="w-full mt-4 text-xs text-gray-400 hover:text-gray-600 py-2">
                üîß Debug Info
            </button>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full text-center">
            <div class="text-6xl mb-4">‚úÖ</div>
            <h3 class="text-2xl font-bold mb-2" id="modalTitle">Absen Berhasil!</h3>
            <p class="text-gray-600 mb-1 text-lg" id="modalName">-</p>
            <p class="text-sm text-gray-500 mb-2" id="modalTime">-</p>
            <p class="text-xs text-gray-400 mb-4" id="modalLocation">üìç Loading...</p>
            <button id="closeModal" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-semibold">
                OK
            </button>
        </div>
    </div>

    <script>
        // ==========================================
        // DEVICE DETECTION
        // ==========================================
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        
        console.log('Device:', isMobile ? 'Mobile' : 'Desktop');
        console.log('Is iOS:', isIOS);

        // ==========================================
        // CONFIGURATION
        // ==========================================
        const CONFIG = {
            // Mobile settings (lighter, faster)
            mobile: {
                videoWidth: 320,
                videoHeight: 240,
                detectionInterval: 800, // ms
                inputSize: 224,
                scoreThreshold: 0.4,
                matchThreshold: 0.65
            },
            // Desktop settings (higher quality)
            desktop: {
                videoWidth: 640,
                videoHeight: 480,
                detectionInterval: 100,
                inputSize: 416,
                scoreThreshold: 0.5,
                matchThreshold: 0.6
            }
        };

        const settings = isMobile ? CONFIG.mobile : CONFIG.desktop;
        console.log('Using settings:', settings);

        // ==========================================
        // GLOBAL VARIABLES
        // ==========================================
        let video, overlay, scanEffect;
        let labeledDescriptors = [];
        let faceMatcher = null;
        let storage = null;
        let isScanning = false;
        let stream = null;
        let detectedEmployee = null;
        let detectionTimeout = null;
        let debugLogs = [];

        // ==========================================
        // DEBUG FUNCTIONS
        // ==========================================
        function debug(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const log = { timestamp, message, type };
            debugLogs.push(log);
            console.log(`[${timestamp}] ${message}`);
            
            // Keep only last 50 logs
            if (debugLogs.length > 50) {
                debugLogs.shift();
            }
            
            updateDebugPanel();
        }

        function updateDebugPanel() {
            const debugLog = document.getElementById('debugLog');
            if (!debugLog) return;
            
            debugLog.innerHTML = debugLogs.slice(-20).reverse().map(log => {
                const color = log.type === 'error' ? 'text-red-600' : 
                             log.type === 'success' ? 'text-green-600' : 'text-gray-600';
                return `<div class="${color}">[${log.timestamp}] ${log.message}</div>`;
            }).join('');
        }

        document.getElementById('toggleDebug')?.addEventListener('click', () => {
            document.getElementById('debugPanel').classList.toggle('hidden');
        });

        document.getElementById('closeDebug')?.addEventListener('click', () => {
            document.getElementById('debugPanel').classList.add('hidden');
        });

        // ==========================================
        // INITIALIZATION
        // ==========================================
        async function initialize() {
            try {
                debug('üöÄ Starting initialization...');
                debug(`üì± Device: ${isMobile ? 'Mobile' : 'Desktop'}`);
                
                document.getElementById('deviceInfo').textContent = 
                    `${isMobile ? 'üì± Mobile' : 'üíª Desktop'} | ${navigator.userAgent.substring(0, 50)}...`;

                updateLoading('Menunggu Firebase...', 'Connecting...');
                
                // Wait for Firebase
                if (window.waitForFirebase) {
                    await window.waitForFirebase();
                    debug('‚úÖ Firebase connected', 'success');
                } else {
                    await new Promise((resolve) => {
                        const checkFirebase = setInterval(() => {
                            if (window.firebaseDB && window.firebaseDB.isReady) {
                                clearInterval(checkFirebase);
                                resolve();
                            }
                        }, 100);
                        setTimeout(() => clearInterval(checkFirebase), 10000);
                    });
                }

                // Initialize storage
                if (typeof FirebaseStorageManager === 'undefined') {
                    throw new Error('FirebaseStorageManager not found');
                }
                storage = new FirebaseStorageManager();
                debug('‚úÖ Storage initialized', 'success');

                // Load face-api models (lighter model for mobile)
                updateLoading('Memuat AI Models...', isMobile ? 'Loading optimized for mobile...' : 'Loading face detection...');
                
                const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
                
                // Load only essential models
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                
                debug('‚úÖ Face-API models loaded', 'success');

                // Load registered employees
                updateLoading('Memuat Data Karyawan...', 'Loading employee database...');
                await loadEmployees();

                // Update UI
                document.getElementById('totalEmployees').textContent = labeledDescriptors.length;

                // Start time update
                setInterval(updateTime, 1000);
                updateTime();

                // Load today's attendance
                await loadTodayAttendance();

                // Hide loading, show content
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');

                debug('‚úÖ System ready!', 'success');

            } catch (error) {
                debug('‚ùå Initialization error: ' + error.message, 'error');
                console.error('Initialization error:', error);
                updateLoading('Gagal memuat sistem', error.message);
                
                setTimeout(() => {
                    document.getElementById('debugPanel').classList.remove('hidden');
                }, 1000);
            }
        }

        // ==========================================
        // LOAD EMPLOYEES
        // ==========================================
        async function loadEmployees() {
            try {
                debug('üì• Loading employees...');
                const users = await storage.getUsers();
                
                debug(`üìä Found ${users.length} employees`);

                if (users.length === 0) {
                    throw new Error('Tidak ada karyawan terdaftar');
                }

                labeledDescriptors = [];

                for (const user of users) {
                    try {
                        if (!user.descriptors || user.descriptors.length === 0) {
                            debug(`‚ö†Ô∏è ${user.label}: No descriptors`, 'error');
                            continue;
                        }

                        // Convert descriptors
                        const descriptors = user.descriptors.map(desc => {
                            if (Array.isArray(desc)) {
                                return new Float32Array(desc);
                            } else if (desc instanceof Float32Array) {
                                return desc;
                            } else {
                                return new Float32Array(Object.values(desc));
                            }
                        });

                        labeledDescriptors.push(
                            new faceapi.LabeledFaceDescriptors(user.label, descriptors)
                        );

                        debug(`‚úÖ ${user.label}: Loaded`, 'success');

                    } catch (error) {
                        debug(`‚ùå Error loading ${user.label}: ${error.message}`, 'error');
                    }
                }

                if (labeledDescriptors.length === 0) {
                    throw new Error('Tidak ada data wajah yang valid');
                }

                // Create FaceMatcher with mobile-optimized threshold
                faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, settings.matchThreshold);
                
                debug(`‚úÖ FaceMatcher ready with ${labeledDescriptors.length} employees`, 'success');
                debug(`üéØ Match threshold: ${settings.matchThreshold}`);

            } catch (error) {
                debug('‚ùå Load employees error: ' + error.message, 'error');
                throw error;
            }
        }

        // ==========================================
        // CAMERA CONTROL
        // ==========================================
        document.getElementById('startBtn').addEventListener('click', async () => {
            try {
                debug('üìπ Starting camera...');
                
                video = document.getElementById('video');
                overlay = document.getElementById('overlay');
                scanEffect = document.getElementById('scanEffect');

                // Mobile-specific camera constraints
                const constraints = {
                    video: {
                        width: { ideal: settings.videoWidth },
                        height: { ideal: settings.videoHeight },
                        facingMode: 'user',
                        // Mobile optimizations
                        frameRate: { ideal: isMobile ? 15 : 30 },
                        aspectRatio: { ideal: 4/3 }
                    }
                };

                debug('üìπ Requesting camera with constraints: ' + JSON.stringify(constraints));

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // Wait for video ready
                await new Promise(resolve => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });

                debug(`‚úÖ Camera started: ${video.videoWidth}x${video.videoHeight}`, 'success');

                // Show video
                document.getElementById('cameraPlaceholder').classList.add('hidden');
                video.classList.remove('hidden');
                overlay.classList.remove('hidden');
                scanEffect.classList.remove('hidden');
                document.getElementById('detectionOverlay').classList.remove('hidden');

                // Update buttons
                document.getElementById('startBtn').classList.add('hidden');
                document.getElementById('stopBtn').classList.remove('hidden');

                // Set canvas size
                const displaySize = { 
                    width: video.videoWidth || settings.videoWidth, 
                    height: video.videoHeight || settings.videoHeight 
                };
                faceapi.matchDimensions(overlay, displaySize);

                isScanning = true;
                
                // Start detection
                detectFace();

            } catch (error) {
                debug('‚ùå Camera error: ' + error.message, 'error');
                showStatus('Gagal mengakses kamera. Pastikan izin kamera diaktifkan.', 'error');
                
                // Show helpful message for mobile
                if (isMobile) {
                    showStatus('üì± Mobile: Pastikan Chrome/Safari sudah mendapat izin kamera', 'error');
                }
            }
        });

        document.getElementById('stopBtn').addEventListener('click', stopCamera);

        function stopCamera() {
            isScanning = false;
            
            if (detectionTimeout) {
                clearTimeout(detectionTimeout);
            }
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }

            if (video) {
                video.srcObject = null;
                video.classList.add('hidden');
            }

            overlay.classList.add('hidden');
            scanEffect.classList.add('hidden');
            document.getElementById('cameraPlaceholder').classList.remove('hidden');
            document.getElementById('detectionOverlay').classList.add('hidden');
            
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('stopBtn').classList.add('hidden');
            document.getElementById('attendanceButtons').classList.add('hidden');
            document.getElementById('recognitionResult').classList.add('hidden');

            detectedEmployee = null;
            debug('üìπ Camera stopped');
        }

        // ==========================================
        // FACE DETECTION (MOBILE OPTIMIZED)
        // ==========================================
        async function detectFace() {
            if (!isScanning || !video) return;

            try {
                document.getElementById('detectionText').textContent = 'Scanning...';

                const detections = await faceapi
                    .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({
                        inputSize: settings.inputSize,
                        scoreThreshold: settings.scoreThreshold
                    }))
                    .withFaceLandmarks()
                    .withFaceDescriptors();

                // Clear overlay
                const ctx = overlay.getContext('2d');
                ctx.clearRect(0, 0, overlay.width, overlay.height);

                if (detections.length > 0) {
                    debug(`üë§ Detected ${detections.length} face(s)`);

                    // Resize detections
                    const displaySize = { 
                        width: video.videoWidth || settings.videoWidth, 
                        height: video.videoHeight || settings.videoHeight 
                    };
                    const resizedDetections = faceapi.resizeResults(detections, displaySize);

                    // Draw on mobile with thicker lines (easier to see)
                    if (isMobile) {
                        ctx.lineWidth = 3;
                        faceapi.draw.drawDetections(overlay, resizedDetections);
                    } else {
                        faceapi.draw.drawDetections(overlay, resizedDetections);
                        faceapi.draw.drawFaceLandmarks(overlay, resizedDetections);
                    }

                    // Match face
                    const detection = detections[0];
                    const bestMatch = faceMatcher.findBestMatch(detection.descriptor);

                    const distance = bestMatch.distance.toFixed(4);
                    const confidence = ((1 - bestMatch.distance) * 100).toFixed(1);
                    
                    debug(`üîç Match: ${bestMatch.label} (dist: ${distance}, conf: ${confidence}%)`);

                    if (bestMatch.label !== 'unknown') {
                        // RECOGNIZED!
                        detectedEmployee = {
                            name: bestMatch.label,
                            confidence: confidence
                        };

                        showRecognitionResult(detectedEmployee);
                        document.getElementById('detectionText').textContent = `‚úÖ ${detectedEmployee.name}`;
                        
                        debug(`‚úÖ RECOGNIZED: ${detectedEmployee.name} (${confidence}%)`, 'success');

                        // Draw result
                        const box = resizedDetections[0].detection.box;
                        const drawBox = new faceapi.draw.DrawBox(box, {
                            label: `${bestMatch.label} (${confidence}%)`,
                            boxColor: 'green',
                            lineWidth: isMobile ? 3 : 2
                        });
                        drawBox.draw(overlay);

                    } else {
                        document.getElementById('detectionText').textContent = '‚ùå Tidak dikenali';
                        showStatus('Wajah tidak dikenali', 'error');
                        debug(`‚ùå Unknown face (distance: ${distance})`, 'error');
                    }

                } else {
                    // No face detected
                    detectedEmployee = null;
                    document.getElementById('detectionText').textContent = 'üë§ Cari wajah...';
                    document.getElementById('recognitionResult').classList.add('hidden');
                    document.getElementById('attendanceButtons').classList.add('hidden');
                }

            } catch (error) {
                debug('‚ùå Detection error: ' + error.message, 'error');
                console.error('Detection error:', error);
            }

            // Continue scanning with mobile-optimized interval
            detectionTimeout = setTimeout(() => detectFace(), settings.detectionInterval);
        }

        // ==========================================
        // SHOW RECOGNITION RESULT
        // ==========================================
        function showRecognitionResult(employee) {
            document.getElementById('detectedName').textContent = employee.name;
            document.getElementById('confidence').textContent = employee.confidence + '%';
            document.getElementById('recognitionResult').classList.remove('hidden');
            document.getElementById('attendanceButtons').classList.remove('hidden');
            
            showStatus(`‚úÖ Terdeteksi: ${employee.name}`, 'success');

            // Vibrate on mobile (if supported)
            if (navigator.vibrate && isMobile) {
                navigator.vibrate(200);
            }
        }

        // ==========================================
        // ATTENDANCE
        // ==========================================
        document.getElementById('checkInBtn').addEventListener('click', () => doAttendance('check-in'));
        document.getElementById('checkOutBtn').addEventListener('click', () => doAttendance('check-out'));

        async function doAttendance(type) {
            if (!detectedEmployee) {
                showStatus('Tidak ada wajah terdeteksi!', 'error');
                return;
            }

            try {
                debug(`üìù Processing ${type} for ${detectedEmployee.name}...`);
                
                // Disable buttons
                document.getElementById('checkInBtn').disabled = true;
                document.getElementById('checkOutBtn').disabled = true;
                
                showStatus('Menyimpan absensi...', 'info');

                // Get location
                const location = await getLocation();

                // Save attendance
                const attendanceData = {
                    name: detectedEmployee.name,
                    type: type,
                    timestamp: new Date().toISOString(),
                    confidence: detectedEmployee.confidence,
                    location: location,
                    device: isMobile ? 'mobile' : 'desktop'
                };

                await storage.saveAttendance(attendanceData);
                
                debug(`‚úÖ ${type} saved!`, 'success');

                // Show success modal
                showSuccessModal(detectedEmployee.name, type, location);

                // Reload attendance
                await loadTodayAttendance();

                // Stop camera
                stopCamera();

                // Re-enable buttons
                document.getElementById('checkInBtn').disabled = false;
                document.getElementById('checkOutBtn').disabled = false;

            } catch (error) {
                debug(`‚ùå Attendance error: ${error.message}`, 'error');
                showStatus('Gagal menyimpan: ' + error.message, 'error');
                
                document.getElementById('checkInBtn').disabled = false;
                document.getElementById('checkOutBtn').disabled = false;
            }
        }

        // ==========================================
        // GET LOCATION
        // ==========================================
        async function getLocation() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    resolve({ address: 'Location not available' });
                    return;
                }

                const timeout = setTimeout(() => {
                    resolve({ address: 'Location timeout' });
                }, 5000);

                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        clearTimeout(timeout);
                        const { latitude, longitude } = position.coords;
                        
                        resolve({
                            lat: latitude,
                            lng: longitude,
                            address: `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`
                        });
                    },
                    (error) => {
                        clearTimeout(timeout);
                        resolve({ address: 'Location denied' });
                    },
                    {
                        timeout: 5000,
                        enableHighAccuracy: false // Faster on mobile
                    }
                );
            });
        }

        // ==========================================
        // LOAD TODAY ATTENDANCE
        // ==========================================
        async function loadTodayAttendance() {
            try {
                const attendance = await storage.getAttendance();
                const today = new Date().toDateString();
                
                const todayRecords = attendance.filter(record => {
                    const recordDate = new Date(record.timestamp);
                    return recordDate.toDateString() === today;
                });

                todayRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                const listContainer = document.getElementById('attendanceList');
                
                if (todayRecords.length === 0) {
                    listContainer.innerHTML = '<p class="text-gray-500 text-center py-4 text-sm">Belum ada absensi hari ini</p>';
                    return;
                }

                listContainer.innerHTML = todayRecords.map(record => {
                    const time = new Date(record.timestamp).toLocaleTimeString('id-ID', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const typeLabel = record.type === 'check-in' ? 
                        '<span class="text-green-600 text-xs">‚úÖ Masuk</span>' : 
                        '<span class="text-red-600 text-xs">üö™ Pulang</span>';
                    
                    return `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <div>
                                <p class="font-semibold text-sm">${record.name}</p>
                                <p class="text-xs text-gray-500">${time}</p>
                            </div>
                            ${typeLabel}
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading attendance:', error);
            }
        }

        // ==========================================
        // UI HELPERS
        // ==========================================
        function updateLoading(text, status) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingStatus').textContent = status;
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            const statusText = document.getElementById('statusText');
            
            statusDiv.classList.remove('hidden', 'bg-blue-100', 'bg-green-100', 'bg-red-100', 
                                      'text-blue-700', 'text-green-700', 'text-red-700');
            
            if (type === 'success') {
                statusDiv.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                statusDiv.classList.add('bg-red-100', 'text-red-700');
            } else {
                statusDiv.classList.add('bg-blue-100', 'text-blue-700');
            }
            
            statusText.textContent = message;
            statusDiv.classList.remove('hidden');
            
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 3000);
        }

        function showSuccessModal(name, type, location) {
            const modal = document.getElementById('successModal');
            const typeText = type === 'check-in' ? 'Absen Masuk Berhasil!' : 'Absen Pulang Berhasil!';
            
            document.getElementById('modalTitle').textContent = typeText;
            document.getElementById('modalName').textContent = name;
            document.getElementById('modalTime').textContent = new Date().toLocaleString('id-ID');
            document.getElementById('modalLocation').textContent = 'üìç ' + (location.address || 'Unknown');
            
            modal.classList.remove('hidden');

            // Auto close after 3 seconds on mobile
            if (isMobile) {
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 3000);
            }
        }

        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('successModal').classList.add('hidden');
        });

        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('id-ID', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ==========================================
        // START APP
        // ==========================================
        window.addEventListener('firebaseReady', initialize);
        
        if (window.firebaseDB && window.firebaseDB.isReady) {
            initialize();
        }

        // Prevent zoom on double tap (iOS)
        if (isIOS) {
            let lastTouchEnd = 0;
            document.addEventListener('touchend', (e) => {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        }

        // Error handling
        window.addEventListener('unhandledrejection', (event) => {
            debug('‚ùå Unhandled error: ' + event.reason, 'error');
        });
    </script>
</body>
</html>
