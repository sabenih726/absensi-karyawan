<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Absensi Karyawan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        .relative-container {
            position: relative;
            width: 100%;
            padding-top: 75%;
        }
        #video, #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-radius: 50%;
            border-top: 8px solid #3498db;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .clock {
            font-family: 'Courier New', monospace;
            font-size: 3rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

    <div id="loader-container" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col justify-center items-center z-50">
        <div class="loader"></div>
        <p id="loader-text" class="mt-4 text-lg font-semibold">Memuat sistem...</p>
    </div>

    <!-- Modal Alert -->
    <div id="alertModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl text-center max-w-md w-full mx-4 transform transition-all">
            <div id="alertIcon" class="text-6xl mb-4">‚úÖ</div>
            <p id="alertMessage" class="text-xl font-semibold mb-2"></p>
            <p id="alertDetail" class="text-gray-600 mb-4"></p>
            <button id="alertClose" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-8 rounded-lg transition">OK</button>
        </div>
    </div>

    <div class="container mx-auto p-4 max-w-6xl">
        <!-- Header -->
        <header class="text-center mb-8 pt-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Sistem Absensi Karyawan</h1>
            
            <!-- Real-time Clock -->
            <div id="clock" class="clock text-blue-600 my-4">00:00:00</div>
            <div id="date" class="text-lg text-gray-600 mb-4">Loading...</div>
            
            <!-- Location Status -->
            <div class="inline-flex items-center gap-2 bg-white px-4 py-2 rounded-full shadow-md">
                <span id="locationIcon">üìç</span>
                <span id="locationText" class="text-sm">Mendapatkan lokasi...</span>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Video Section -->
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">üì∏ Kamera</h2>
                <div class="relative-container rounded-xl overflow-hidden border-2 border-gray-200">
                    <video id="video" autoplay muted playsinline></video>
                    <canvas id="canvas"></canvas>
                </div>
                
                <!-- User Recognition Status -->
                <div id="recognitionStatus" class="mt-4 p-4 rounded-lg bg-gray-50 text-center">
                    <p class="text-sm text-gray-500">Arahkan wajah ke kamera</p>
                    <p id="recognizedName" class="text-2xl font-bold text-gray-800 mt-2">-</p>
                </div>
            </div>

            <!-- Attendance Section -->
            <div class="space-y-6">
                <!-- Attendance Buttons -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">‚è∞ Absensi</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button id="checkInBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-6 px-6 rounded-xl transition transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span class="text-3xl mb-2 block">üì•</span>
                            <span class="text-lg">MASUK</span>
                            <span id="checkInTime" class="block text-sm mt-1 opacity-75">Belum absen</span>
                        </button>
                        
                        <button id="checkOutBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-6 px-6 rounded-xl transition transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span class="text-3xl mb-2 block">üì§</span>
                            <span class="text-lg">PULANG</span>
                            <span id="checkOutTime" class="block text-sm mt-1 opacity-75">Belum absen</span>
                        </button>
                    </div>
                    
                    <!-- Work Duration -->
                    <div id="workDuration" class="mt-6 p-4 bg-blue-50 rounded-lg hidden">
                        <p class="text-sm text-gray-600">Durasi Kerja Hari Ini:</p>
                        <p class="text-2xl font-bold text-blue-600" id="durationText">0 jam 0 menit</p>
                    </div>
                </div>

                <!-- Today's Activity -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">üìä Aktivitas Hari Ini</h2>
                    <div id="todayActivity" class="space-y-3 max-h-64 overflow-y-auto">
                        <p class="text-gray-500 text-center py-4">Belum ada aktivitas</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // === STORAGE MANAGER ===
        class StorageManager {
            constructor() {
                this.USERS_KEY = 'faceRecognition_users';
                this.ATTENDANCE_KEY = 'faceRecognition_attendance';
            }

            getUsers() {
                const data = localStorage.getItem(this.USERS_KEY);
                return data ? JSON.parse(data) : [];
            }

            getAttendance() {
                const data = localStorage.getItem(this.ATTENDANCE_KEY);
                return data ? JSON.parse(data) : [];
            }

            saveAttendance(attendance) {
                localStorage.setItem(this.ATTENDANCE_KEY, JSON.stringify(attendance));
            }

            addAttendance(record) {
                const attendance = this.getAttendance();
                attendance.push({ 
                    id: Date.now().toString(), 
                    timestamp: new Date().toISOString(), 
                    ...record 
                });
                this.saveAttendance(attendance);
                return attendance;
            }

            getTodayAttendance(name = null) {
                const all = this.getAttendance();
                const today = new Date().toDateString();
                let filtered = all.filter(a => new Date(a.timestamp).toDateString() === today);
                
                if (name) {
                    filtered = filtered.filter(a => a.name === name);
                }
                
                return filtered;
            }
        }

        // === VOICE MANAGER ===
        class VoiceManager {
            constructor() {
                this.synthesis = window.speechSynthesis;
            }

            speak(text) {
                if (!('speechSynthesis' in window)) return;
                
                this.synthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'id-ID';
                utterance.rate = 1.0;
                this.synthesis.speak(utterance);
            }
        }

        // === LOCATION MANAGER ===
        class LocationManager {
            constructor() {
                this.currentLocation = null;
            }

            async getCurrentLocation() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Geolocation tidak didukung'));
                        return;
                    }

                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const coords = {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                                accuracy: position.coords.accuracy
                            };
                            
                            try {
                                const address = await this.reverseGeocode(coords.latitude, coords.longitude);
                                this.currentLocation = {
                                    ...coords,
                                    address: address,
                                    timestamp: new Date().toISOString()
                                };
                                resolve(this.currentLocation);
                            } catch (error) {
                                this.currentLocation = {
                                    ...coords,
                                    address: `${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}`,
                                    timestamp: new Date().toISOString()
                                };
                                resolve(this.currentLocation);
                            }
                        },
                        (error) => reject(error),
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                });
            }

            async reverseGeocode(lat, lon) {
                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`,
                        { headers: { 'Accept-Language': 'id' } }
                    );
                    
                    if (!response.ok) throw new Error('Geocoding failed');
                    
                    const data = await response.json();
                    const address = data.address;
                    const parts = [];
                    
                    if (address.road) parts.push(address.road);
                    if (address.suburb) parts.push(address.suburb);
                    if (address.city || address.town) parts.push(address.city || address.town);
                    
                    return parts.length > 0 ? parts.join(', ') : data.display_name;
                } catch (error) {
                    return `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                }
            }
        }

        // === Initialize Managers ===
        const storage = new StorageManager();
        const voiceManager = new VoiceManager();
        const locationManager = new LocationManager();

        // === DOM Elements ===
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const checkInBtn = document.getElementById('checkInBtn');
        const checkOutBtn = document.getElementById('checkOutBtn');
        const checkInTime = document.getElementById('checkInTime');
        const checkOutTime = document.getElementById('checkOutTime');
        const recognizedName = document.getElementById('recognizedName');
        const todayActivity = document.getElementById('todayActivity');
        const workDuration = document.getElementById('workDuration');
        const durationText = document.getElementById('durationText');
        const loaderContainer = document.getElementById('loader-container');
        const loaderText = document.getElementById('loader-text');
        const alertModal = document.getElementById('alertModal');
        const alertMessage = document.getElementById('alertMessage');
        const alertDetail = document.getElementById('alertDetail');
        const alertIcon = document.getElementById('alertIcon');
        const alertClose = document.getElementById('alertClose');
        const clock = document.getElementById('clock');
        const dateElement = document.getElementById('date');
        const locationText = document.getElementById('locationText');
        const locationIcon = document.getElementById('locationIcon');

        // === Global Variables ===
        let faceMatcher = null;
        let currentUser = null;

        // === Clock Update ===
        function updateClock() {
            const now = new Date();
            clock.textContent = now.toLocaleTimeString('id-ID');
            dateElement.textContent = now.toLocaleDateString('id-ID', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }
        setInterval(updateClock, 1000);
        updateClock();

        // === Show Alert ===
        function showAlert(message, detail = '', icon = '‚úÖ') {
            alertMessage.textContent = message;
            alertDetail.textContent = detail;
            alertIcon.textContent = icon;
            alertModal.classList.remove('hidden');
            voiceManager.speak(message);
        }

        alertClose.addEventListener('click', () => {
            alertModal.classList.add('hidden');
        });

        // === Update Location ===
        async function updateLocation() {
            try {
                locationText.textContent = 'Mendapatkan lokasi...';
                locationIcon.textContent = 'üîÑ';
                
                const location = await locationManager.getCurrentLocation();
                locationIcon.textContent = 'üìç';
                locationText.textContent = location.address;
            } catch (error) {
                locationIcon.textContent = '‚ùå';
                locationText.textContent = 'Lokasi tidak tersedia';
            }
        }

        // === Load Models ===
        async function loadModels() {
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
            try {
                loaderText.innerText = 'Memuat model deteksi wajah...';
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                loaderText.innerText = 'Memuat model landmark wajah...';
                await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                loaderText.innerText = 'Memuat model pengenalan wajah...';
                await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
                return true;
            } catch (error) {
                console.error("Gagal memuat model:", error);
                return false;
            }
        }

        // === Start Webcam ===
        function startWebcam() {
            navigator.mediaDevices.getUserMedia({ video: {} })
                .then(stream => { video.srcObject = stream; })
                .catch(err => {
                    console.error("Error:", err);
                    showAlert("Tidak bisa mengakses kamera", "Pastikan Anda memberikan izin", "‚ùå");
                });
        }

        // === Load Face Matcher ===
        function loadFaceMatcher() {
            const users = storage.getUsers();
            if (users.length > 0) {
                const labeledDescriptors = users.map(user => {
                    const descriptors = user.descriptors.map(d => new Float32Array(Object.values(d)));
                    return new faceapi.LabeledFaceDescriptors(user.label, descriptors);
                });
                faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6);
            }
        }

        // === Update Today Activity ===
        function updateTodayActivity() {
            if (!currentUser) return;
            
            const activities = storage.getTodayAttendance(currentUser);
            todayActivity.innerHTML = '';
            
            if (activities.length === 0) {
                todayActivity.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada aktivitas</p>';
                checkInTime.textContent = 'Belum absen';
                checkOutTime.textContent = 'Belum absen';
                workDuration.classList.add('hidden');
                return;
            }

            // Update button status
            const checkIn = activities.find(a => a.type === 'check-in');
            const checkOut = activities.find(a => a.type === 'check-out');

            if (checkIn) {
                const time = new Date(checkIn.timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                checkInTime.textContent = time;
                checkInBtn.disabled = true;
            } else {
                checkInBtn.disabled = false;
            }

            if (checkOut) {
                const time = new Date(checkOut.timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                checkOutTime.textContent = time;
                checkOutBtn.disabled = true;
            } else {
                checkOutBtn.disabled = !checkIn;
            }

            // Calculate duration
            if (checkIn && checkOut) {
                const duration = new Date(checkOut.timestamp) - new Date(checkIn.timestamp);
                const hours = Math.floor(duration / (1000 * 60 * 60));
                const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
                durationText.textContent = `${hours} jam ${minutes} menit`;
                workDuration.classList.remove('hidden');
            }

            // Display activities
            activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            activities.forEach(activity => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                
                const type = activity.type === 'check-in' ? 
                    '<span class="text-green-600 font-semibold">üì• Masuk</span>' : 
                    '<span class="text-red-600 font-semibold">üì§ Pulang</span>';
                
                const time = new Date(activity.timestamp).toLocaleTimeString('id-ID');
                
                div.innerHTML = `
                    ${type}
                    <span class="text-gray-600 text-sm">${time}</span>
                `;
                todayActivity.appendChild(div);
            });
        }

        // === Handle Check In/Out ===
        async function handleAttendance(type) {
            if (!currentUser) {
                showAlert("Wajah tidak dikenali", "Pastikan wajah Anda terlihat jelas di kamera", "‚ö†Ô∏è");
                return;
            }

            // Check if already done today
            const todayAttendance = storage.getTodayAttendance(currentUser);
            const alreadyDone = todayAttendance.find(a => a.type === type);
            
            if (alreadyDone) {
                showAlert("Sudah melakukan absensi", `Anda sudah ${type === 'check-in' ? 'masuk' : 'pulang'} hari ini`, "‚ö†Ô∏è");
                return;
            }

            // Update location
            await updateLocation();
            const location = locationManager.currentLocation;

            // Save attendance
            storage.addAttendance({
                name: currentUser,
                type: type,
                location: location
            });

            // Show success
            const typeText = type === 'check-in' ? 'Masuk' : 'Pulang';
            showAlert(
                `Absensi ${typeText} Berhasil!`,
                `${currentUser} - ${new Date().toLocaleTimeString('id-ID')}`,
                type === 'check-in' ? '‚úÖ' : 'üëã'
            );

            // Update UI
            updateTodayActivity();
        }

        checkInBtn.addEventListener('click', () => handleAttendance('check-in'));
        checkOutBtn.addEventListener('click', () => handleAttendance('check-out'));

        // === Face Detection Loop ===
        video.addEventListener('play', () => {
            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);
            
            setInterval(async () => {
                if (!faceMatcher) return;
                
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptors();
                
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                let recognized = false;
                
                resizedDetections.forEach(detection => {
                    const result = faceMatcher.findBestMatch(detection.descriptor);
                    const box = detection.detection.box;
                    
                    if (result.label !== 'unknown') {
                        currentUser = result.label;
                        recognized = true;
                        recognizedName.textContent = currentUser;
                        recognizedName.className = 'text-2xl font-bold text-green-600 mt-2';
                        
                        const drawBox = new faceapi.draw.DrawBox(box, { 
                            label: currentUser,
                            boxColor: 'green'
                        });
                        drawBox.draw(canvas);
                    } else {
                        const drawBox = new faceapi.draw.DrawBox(box, { 
                            label: 'Tidak Dikenali',
                            boxColor: 'red'
                        });
                        drawBox.draw(canvas);
                    }
                });
                
                if (!recognized) {
                    currentUser = null;
                    recognizedName.textContent = 'Tidak Dikenali';
                    recognizedName.className = 'text-2xl font-bold text-red-600 mt-2';
                } else {
                    updateTodayActivity();
                }
            }, 500);
        });

        // === Initialize ===
        async function initialize() {
            try {
                await loadModels();
                loadFaceMatcher();
                updateLocation();
                loaderContainer.style.display = 'none';
                startWebcam();
                voiceManager.speak('Sistem absensi siap digunakan');
            } catch (error) {
                console.error("Init error:", error);
                loaderText.innerText = 'Gagal memuat sistem';
            }
        }

        initialize();
    </script>
</body>
</html>