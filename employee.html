<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portal Karyawan - Absensi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { overscroll-behavior: none; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50 p-4">
        <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-lg font-semibold text-gray-700 text-center" id="loadingText">Memuat sistem...</p>
        <p class="mt-2 text-sm text-gray-500 text-center" id="loadingStatus">Menginisialisasi...</p>
        
        <!-- Error Display -->
        <div id="errorDisplay" class="hidden mt-6 p-4 bg-red-50 border-2 border-red-300 rounded-lg max-w-md">
            <p class="text-red-700 font-bold mb-2">‚ùå Error:</p>
            <p id="errorMessage" class="text-red-600 text-sm"></p>
            <button onclick="location.reload()" class="mt-4 w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">
                üîÑ Muat Ulang
            </button>
        </div>

        <!-- Debug Log -->
        <div id="initLog" class="mt-6 p-4 bg-gray-100 rounded-lg max-w-md text-xs max-h-48 overflow-y-auto hidden">
            <p class="font-bold mb-2">üìã Initialization Log:</p>
            <div id="logContent"></div>
        </div>
        
        <button id="toggleLog" class="mt-4 text-xs text-gray-500 hover:text-gray-700">
            üîß Show Debug Log
        </button>
    </div>

    <!-- Main Container -->
    <div id="mainContent" class="hidden min-h-screen pb-20">
        
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 sticky top-0 z-10 shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl md:text-2xl font-bold">Portal Karyawan</h1>
                    <p class="text-xs md:text-sm text-blue-100 mt-1">Absensi Face Recognition</p>
                </div>
                <a href="index.html" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-3 py-2 rounded-lg text-sm">
                    üè†
                </a>
            </div>
            
            <div class="mt-3 flex items-center justify-between text-xs">
                <span id="currentTime">--:--</span>
                <span>Karyawan: <strong id="totalEmployees">0</strong></span>
                <span id="systemStatus">üü¢</span>
            </div>
        </div>

        <!-- Camera Section -->
        <div class="p-4">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                
                <!-- Video Container -->
                <div class="relative bg-black" style="aspect-ratio: 4/3;">
                    <video id="video" autoplay playsinline muted class="w-full h-full object-cover hidden"></video>
                    <canvas id="overlay" class="absolute top-0 left-0 w-full h-full hidden"></canvas>
                    
                    <div id="cameraPlaceholder" class="absolute inset-0 flex items-center justify-center">
                        <div class="text-center text-white">
                            <div class="text-6xl mb-4">üìπ</div>
                            <p class="text-sm px-4">Tekan tombol untuk mulai</p>
                        </div>
                    </div>

                    <!-- Status Overlay -->
                    <div id="statusOverlay" class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-4 hidden">
                        <p class="text-white text-center font-semibold text-sm" id="scanStatus">Scanning...</p>
                    </div>
                </div>

                <!-- Recognition Card - LOCKED -->
                <div id="recognitionCard" class="p-6 bg-green-50 border-l-4 border-green-500 hidden">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">üîí Terdeteksi & Terkunci:</p>
                            <p class="text-2xl font-bold text-gray-800" id="lockedName">-</p>
                            <p class="text-xs text-gray-500 mt-1">Confidence: <span id="lockedConfidence">0%</span></p>
                        </div>
                        <div class="text-5xl">‚úÖ</div>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="p-4 space-y-2">
                    <button id="startBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-4 rounded-lg font-semibold text-lg">
                        üìπ Mulai Scan
                    </button>
                    
                    <div id="actionButtons" class="hidden space-y-2">
                        <button id="checkInBtn" class="w-full bg-green-500 hover:bg-green-600 text-white py-4 rounded-lg font-semibold text-lg">
                            ‚úÖ Absen Masuk
                        </button>
                        <button id="checkOutBtn" class="w-full bg-red-500 hover:bg-red-600 text-white py-4 rounded-lg font-semibold text-lg">
                            üö™ Absen Pulang
                        </button>
                        <button id="rescanBtn" class="w-full bg-gray-400 hover:bg-gray-500 text-white py-3 rounded-lg font-semibold">
                            üîÑ Scan Ulang
                        </button>
                    </div>
                    
                    <button id="stopBtn" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg font-semibold hidden">
                        ‚èπÔ∏è Stop
                    </button>
                </div>
            </div>

            <!-- Today's Attendance -->
            <div class="bg-white rounded-xl shadow-lg p-4 mt-4">
                <h3 class="text-lg font-bold mb-3">Riwayat Hari Ini</h3>
                <div id="attendanceList" class="space-y-2">
                    <p class="text-gray-500 text-center py-4 text-sm">Memuat...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full text-center">
            <div class="text-6xl mb-4">‚úÖ</div>
            <h3 class="text-2xl font-bold mb-2" id="modalTitle">Berhasil!</h3>
            <p class="text-gray-600 mb-1 text-lg" id="modalName">-</p>
            <p class="text-sm text-gray-500 mb-2" id="modalTime">-</p>
            <button id="closeModal" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-semibold mt-4">
                OK
            </button>
        </div>
    </div>

    <!-- Load Firebase Config FIRST -->
    <script type="module" src="firebase-config.js"></script>
    <script src="storage-firebase.js"></script>

    <script>
        // ==========================================
        // GLOBAL CONFIG
        // ==========================================
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        const CONFIG = {
            videoWidth: isMobile ? 320 : 640,
            videoHeight: isMobile ? 240 : 480,
            detectionInterval: isMobile ? 1000 : 500,
            matchThreshold: 0.65,
            stableCount: 3 // Butuh 3x deteksi sama
        };

        // ==========================================
        // GLOBAL STATE
        // ==========================================
        let storage = null;
        let faceMatcher = null;
        let isScanning = false;
        let isLocked = false;
        let videoStream = null;
        let detectionTimer = null;
        let lockedEmployee = null;
        let recognitionHistory = [];
        
        const logs = [];

        // ==========================================
        // LOGGING
        // ==========================================
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push(logEntry);
            console.log(logEntry);
            
            const logContent = document.getElementById('logContent');
            if (logContent) {
                const color = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-600';
                logContent.innerHTML = logs.slice(-20).reverse().map(l => `<div class="${color}">${l}</div>`).join('');
            }
        }

        document.getElementById('toggleLog')?.addEventListener('click', () => {
            document.getElementById('initLog').classList.toggle('hidden');
        });

        function updateStatus(text, status) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingStatus').textContent = status;
            log(`${text} - ${status}`);
        }

        function showError(message) {
            log(message, 'error');
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorDisplay').classList.remove('hidden');
            document.getElementById('initLog').classList.remove('hidden');
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================
        async function initialize() {
            try {
                log('üöÄ Starting initialization...');
                log(`üì± Device: ${isMobile ? 'Mobile' : 'Desktop'}`);

                // Step 1: Wait for Firebase
                updateStatus('Step 1/4', 'Waiting for Firebase...');
                
                let firebaseReady = false;
                let attempts = 0;
                const maxAttempts = 30;

                while (!firebaseReady && attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    if (window.firebaseDB && window.firebaseDB.isReady) {
                        firebaseReady = true;
                        log('‚úÖ Firebase ready', 'success');
                    } else {
                        attempts++;
                        log(`‚è≥ Waiting for Firebase... (${attempts}/${maxAttempts})`);
                    }
                }

                if (!firebaseReady) {
                    throw new Error('Firebase timeout. Pastikan file firebase-config.js sudah di-load.');
                }

                // Step 2: Initialize Storage
                updateStatus('Step 2/4', 'Initializing storage...');
                
                if (typeof FirebaseStorageManager === 'undefined') {
                    throw new Error('FirebaseStorageManager not found. Pastikan file storage-firebase.js sudah di-load.');
                }

                storage = new FirebaseStorageManager();
                log('‚úÖ Storage initialized', 'success');

                // Step 3: Load Face-API Models
                updateStatus('Step 3/4', 'Loading AI models...');
                
                const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
                
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                
                log('‚úÖ Face-API models loaded', 'success');

                // Step 4: Load Employees
                updateStatus('Step 4/4', 'Loading employees...');
                
                const users = await storage.getUsers();
                log(`üìä Found ${users.length} registered users`);

                if (users.length === 0) {
                    throw new Error('Tidak ada karyawan terdaftar. Silakan registrasi di halaman admin terlebih dahulu.');
                }

                // Build FaceMatcher
                const labeledDescriptors = [];
                
                for (const user of users) {
                    try {
                        if (!user.descriptors || user.descriptors.length === 0) {
                            log(`‚ö†Ô∏è ${user.label}: No descriptors`);
                            continue;
                        }

                        const descriptors = user.descriptors.map(desc => {
                            if (Array.isArray(desc)) return new Float32Array(desc);
                            if (desc instanceof Float32Array) return desc;
                            return new Float32Array(Object.values(desc));
                        });

                        labeledDescriptors.push(
                            new faceapi.LabeledFaceDescriptors(user.label, descriptors)
                        );

                        log(`‚úÖ ${user.label}: Loaded`, 'success');

                    } catch (error) {
                        log(`‚ùå Error loading ${user.label}: ${error.message}`, 'error');
                    }
                }

                if (labeledDescriptors.length === 0) {
                    throw new Error('Tidak ada data wajah yang valid');
                }

                faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, CONFIG.matchThreshold);
                log(`‚úÖ FaceMatcher ready with ${labeledDescriptors.length} employees`, 'success');

                // Update UI
                document.getElementById('totalEmployees').textContent = labeledDescriptors.length;

                // Load today's attendance
                await loadTodayAttendance();

                // Start time update
                setInterval(updateTime, 1000);
                updateTime();

                // Hide loading, show content
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');

                log('‚úÖ System ready!', 'success');

            } catch (error) {
                log(`‚ùå Initialization failed: ${error.message}`, 'error');
                console.error('Init error:', error);
                showError(error.message);
            }
        }

        // ==========================================
        // CAMERA
        // ==========================================
        document.getElementById('startBtn').addEventListener('click', startCamera);
        document.getElementById('stopBtn').addEventListener('click', stopCamera);
        document.getElementById('rescanBtn').addEventListener('click', rescan);

        async function startCamera() {
            try {
                log('üìπ Starting camera...');

                const video = document.getElementById('video');
                const overlay = document.getElementById('overlay');

                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: CONFIG.videoWidth },
                        height: { ideal: CONFIG.videoHeight },
                        facingMode: 'user'
                    }
                });

                video.srcObject = videoStream;
                await new Promise(resolve => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });

                log(`‚úÖ Camera started: ${video.videoWidth}x${video.videoHeight}`, 'success');

                // Show video
                document.getElementById('cameraPlaceholder').classList.add('hidden');
                video.classList.remove('hidden');
                overlay.classList.remove('hidden');
                document.getElementById('statusOverlay').classList.remove('hidden');

                // Update buttons
                document.getElementById('startBtn').classList.add('hidden');
                document.getElementById('stopBtn').classList.remove('hidden');

                // Set canvas size
                faceapi.matchDimensions(overlay, {
                    width: video.videoWidth,
                    height: video.videoHeight
                });

                isScanning = true;
                isLocked = false;
                recognitionHistory = [];

                detectFace();

            } catch (error) {
                log(`‚ùå Camera error: ${error.message}`, 'error');
                alert('Gagal mengakses kamera. Pastikan izin kamera diaktifkan.');
            }
        }

        function stopCamera() {
            isScanning = false;
            isLocked = false;
            
            if (detectionTimer) clearTimeout(detectionTimer);
            
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }

            const video = document.getElementById('video');
            video.srcObject = null;
            video.classList.add('hidden');
            
            document.getElementById('overlay').classList.add('hidden');
            document.getElementById('cameraPlaceholder').classList.remove('hidden');
            document.getElementById('statusOverlay').classList.add('hidden');
            
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('stopBtn').classList.add('hidden');
            document.getElementById('actionButtons').classList.add('hidden');
            document.getElementById('recognitionCard').classList.add('hidden');

            lockedEmployee = null;
            recognitionHistory = [];
            
            log('üìπ Camera stopped');
        }

        function rescan() {
            log('üîÑ Rescanning...');
            isLocked = false;
            lockedEmployee = null;
            recognitionHistory = [];
            
            document.getElementById('actionButtons').classList.add('hidden');
            document.getElementById('recognitionCard').classList.add('hidden');
            document.getElementById('statusOverlay').classList.remove('hidden');
            
            isScanning = true;
            detectFace();
        }

        // ==========================================
        // FACE DETECTION
        // ==========================================
        async function detectFace() {
            if (!isScanning || isLocked) return;

            try {
                const video = document.getElementById('video');
                const overlay = document.getElementById('overlay');
                
                const detections = await faceapi
                    .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({
                        inputSize: 224,
                        scoreThreshold: 0.5
                    }))
                    .withFaceLandmarks()
                    .withFaceDescriptors();

                // Clear canvas
                const ctx = overlay.getContext('2d');
                ctx.clearRect(0, 0, overlay.width, overlay.height);

                if (detections.length > 0) {
                    const displaySize = { width: video.videoWidth, height: video.videoHeight };
                    const resizedDetections = faceapi.resizeResults(detections, displaySize);

                    faceapi.draw.drawDetections(overlay, resizedDetections);

                    const detection = detections[0];
                    const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                    const confidence = ((1 - bestMatch.distance) * 100).toFixed(1);

                    if (bestMatch.label !== 'unknown') {
                        // Add to history
                        recognitionHistory.push({
                            name: bestMatch.label,
                            confidence: confidence,
                            time: Date.now()
                        });

                        // Keep only recent
                        recognitionHistory = recognitionHistory.filter(h => 
                            Date.now() - h.time < 3000
                        );

                        // Count matches
                        const matches = recognitionHistory.filter(h => h.name === bestMatch.label);
                        
                        document.getElementById('scanStatus').textContent = 
                            `${bestMatch.label} (${matches.length}/${CONFIG.stableCount}) - ${confidence}%`;

                        log(`üîç Detected: ${bestMatch.label} - ${matches.length}/${CONFIG.stableCount}`);

                        // LOCK if stable
                        if (matches.length >= CONFIG.stableCount) {
                            lockEmployee({
                                name: bestMatch.label,
                                confidence: confidence
                            });
                        }

                    } else {
                        document.getElementById('scanStatus').textContent = '‚ùå Tidak dikenali';
                        recognitionHistory = [];
                    }

                } else {
                    document.getElementById('scanStatus').textContent = 'üë§ Cari wajah...';
                    recognitionHistory = [];
                }

            } catch (error) {
                log(`‚ùå Detection error: ${error.message}`, 'error');
            }

            detectionTimer = setTimeout(detectFace, CONFIG.detectionInterval);
        }

        // ==========================================
        // LOCK EMPLOYEE
        // ==========================================
        function lockEmployee(employee) {
            if (isLocked) return;

            isLocked = true;
            isScanning = false;
            lockedEmployee = employee;

            log(`üîí LOCKED: ${employee.name} (${employee.confidence}%)`, 'success');

            // Update UI
            document.getElementById('lockedName').textContent = employee.name;
            document.getElementById('lockedConfidence').textContent = employee.confidence + '%';
            
            document.getElementById('recognitionCard').classList.remove('hidden');
            document.getElementById('actionButtons').classList.remove('hidden');
            document.getElementById('statusOverlay').classList.add('hidden');

            // Vibrate
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }
        }

        // ==========================================
        // ATTENDANCE
        // ==========================================
        document.getElementById('checkInBtn').addEventListener('click', () => doAttendance('check-in'));
        document.getElementById('checkOutBtn').addEventListener('click', () => doAttendance('check-out'));

        async function doAttendance(type) {
            if (!lockedEmployee || !isLocked) {
                alert('Tidak ada wajah yang terkunci!');
                return;
            }

            try {
                log(`üìù Processing ${type} for ${lockedEmployee.name}...`);

                // Disable buttons
                document.getElementById('checkInBtn').disabled = true;
                document.getElementById('checkOutBtn').disabled = true;

                const attendanceData = {
                    name: lockedEmployee.name,
                    type: type,
                    timestamp: new Date().toISOString(),
                    confidence: lockedEmployee.confidence,
                    location: { address: 'Location data' },
                    device: isMobile ? 'mobile' : 'desktop'
                };

                await storage.saveAttendance(attendanceData);

                log(`‚úÖ ${type} saved!`, 'success');

                // Show success modal
                const typeText = type === 'check-in' ? 'Absen Masuk Berhasil!' : 'Absen Pulang Berhasil!';
                document.getElementById('modalTitle').textContent = typeText;
                document.getElementById('modalName').textContent = lockedEmployee.name;
                document.getElementById('modalTime').textContent = new Date().toLocaleString('id-ID');
                document.getElementById('successModal').classList.remove('hidden');

                // Reload attendance list
                await loadTodayAttendance();

                // Stop camera
                stopCamera();

            } catch (error) {
                log(`‚ùå Attendance error: ${error.message}`, 'error');
                alert('Gagal menyimpan absensi: ' + error.message);
                
                document.getElementById('checkInBtn').disabled = false;
                document.getElementById('checkOutBtn').disabled = false;
            }
        }

        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('successModal').classList.add('hidden');
        });

        // ==========================================
        // LOAD ATTENDANCE
        // ==========================================
        async function loadTodayAttendance() {
            try {
                const attendance = await storage.getAttendance();
                const today = new Date().toDateString();
                
                const todayRecords = attendance.filter(r => 
                    new Date(r.timestamp).toDateString() === today
                );

                todayRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                const listContainer = document.getElementById('attendanceList');
                
                if (todayRecords.length === 0) {
                    listContainer.innerHTML = '<p class="text-gray-500 text-center py-4 text-sm">Belum ada absensi</p>';
                    return;
                }

                listContainer.innerHTML = todayRecords.map(r => {
                    const time = new Date(r.timestamp).toLocaleTimeString('id-ID', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const typeLabel = r.type === 'check-in' ? 
                        '<span class="text-green-600 text-xs">‚úÖ Masuk</span>' : 
                        '<span class="text-red-600 text-xs">üö™ Pulang</span>';
                    
                    return `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <div>
                                <p class="font-semibold text-sm">${r.name}</p>
                                <p class="text-xs text-gray-500">${time}</p>
                            </div>
                            ${typeLabel}
                        </div>
                    `;
                }).join('');

            } catch (error) {
                log(`‚ùå Error loading attendance: ${error.message}`, 'error');
            }
        }

        // ==========================================
        // UTILITIES
        // ==========================================
        function updateTime() {
            document.getElementById('currentTime').textContent = new Date().toLocaleTimeString('id-ID', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ==========================================
        // START
        // ==========================================
        window.addEventListener('firebaseReady', initialize);
        
        if (window.firebaseDB && window.firebaseDB.isReady) {
            initialize();
        } else {
            setTimeout(() => {
                if (!storage) {
                    initialize();
                }
            }, 2000);
        }
    </script>
</body>
</html>
