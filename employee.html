<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Portal ‚Äì Attendance System</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#FFA500">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Absensi">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/assets/logo-trakindo.png">
    
    <!-- Library - DIRECT LOAD (Original approach) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <!-- ‚òùÔ∏è KUNCI: Direct load, bukan lazy! -->
    
    <script type="module" src="firebase-config.js"></script>
    <script src="storage-firebase.js"></script>

    <!-- Style (sama seperti original) -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .relative-container {
            position: relative;
            width: 100%;
            padding-top: 75%;
            background-color: #000;
        }

        #video,
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .loader {
            border: 8px solid #f3f3f3;
            border-radius: 50%;
            border-top: 8px solid #3498db;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .clock {
            font-family: 'Courier New', monospace;
            font-size: 3rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        @media (max-width: 768px) {
            .clock {
                font-size: 2rem;
            }
        }

        @media (max-width: 480px) {
            .clock {
                font-size: 1.5rem;
            }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

<!-- Loader -->
<div id="loader-container" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col justify-center items-center z-50">
    <div class="loader"></div>
    <p id="loader-text" class="mt-4 text-lg font-semibold text-gray-700">Memuat sistem...</p>
</div>

<!-- Alert Modal -->
<div id="alertModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-md w-full mx-4 transform transition-all">
        <div id="alertIcon" class="text-6xl mb-4">‚úÖ</div>
        <p id="alertMessage" class="text-xl font-bold mb-2 text-gray-800"></p>
        <p id="alertDetail" class="text-gray-600 mb-6"></p>
        <button id="alertClose" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg transition duration-300 transform hover:scale-105">
            OK
        </button>
    </div>
</div>

<!-- Main Container -->
<div class="container mx-auto px-4 py-6 max-w-7xl">

    <!-- Header -->
    <header class="text-center mb-8">
        <div class="mb-4 flex justify-center">
            <a href="index.html" class="inline-flex items-center gap-2 bg-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition duration-200 text-gray-700 hover:text-blue-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                <span class="font-medium">Kembali ke Home</span>
            </a>
        </div>

        <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-gray-800 mb-4">
            Employee Attendance System
        </h1>

        <div id="clock" class="clock text-blue-600 my-4">00:00:00</div>
        <div id="date" class="text-base md:text-lg text-gray-600 mb-4">Loading...</div>

        <div id="networkStatus" class="inline-flex items-center gap-2 bg-green-100 text-green-700 px-4 py-2 rounded-full text-sm font-medium mb-4">
            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
            <span>Online</span>
        </div>

        <div class="inline-flex items-center gap-2 bg-white px-6 py-3 rounded-full shadow-lg border border-gray-200">
            <span id="locationIcon" class="text-xl">üìç</span>
            <span id="locationText" class="text-sm md:text-base font-medium text-gray-700">
                Mendapatkan lokasi...
            </span>
            <button id="refreshLocationBtn" onclick="updateLocation()" class="ml-2 p-2 hover:bg-gray-100 rounded-full transition duration-200" title="Perbarui lokasi">
                <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8">

        <!-- Camera Section -->
        <section class="bg-white rounded-2xl shadow-xl p-6 lg:p-8">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center gap-2">
                <span>üì∏</span>
                <span>Kamera</span>
            </h2>

            <div class="relative-container rounded-xl overflow-hidden border-4 border-gray-200 shadow-inner mb-4">
                <video id="video" autoplay muted playsinline></video>
                <canvas id="canvas"></canvas>
            </div>

            <div id="recognitionStatus" class="p-6 rounded-xl bg-gradient-to-r from-gray-50 to-gray-100 text-center border border-gray-200">
                <p class="text-sm text-gray-500 mb-2">Arahkan wajah ke kamera</p>
                <p id="recognizedName" class="text-2xl md:text-3xl font-bold text-gray-800">-</p>
            </div>
        </section>

        <!-- Attendance Section -->
        <div class="space-y-6">
            <section class="bg-white rounded-2xl shadow-xl p-6 lg:p-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center gap-2">
                    <span>‚è∞</span>
                    <span>Absensi</span>
                </h2>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <button id="checkInBtn" class="bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-6 px-6 rounded-xl shadow-lg transition transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                        <span class="text-4xl mb-2 block">üì•</span>
                        <span class="text-xl block mb-1">MASUK</span>
                        <span id="checkInTime" class="block text-sm opacity-90">Belum absen</span>
                    </button>

                    <button id="checkOutBtn" class="bg-gradient-to-br from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-6 px-6 rounded-xl shadow-lg transition transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                        <span class="text-4xl mb-2 block">üì§</span>
                        <span class="text-xl block mb-1">PULANG</span>
                        <span id="checkOutTime" class="block text-sm opacity-90">Belum absen</span>
                    </button>
                </div>

                <div id="workDuration" class="mt-6 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border-2 border-blue-200 hidden">
                    <p class="text-sm text-gray-600 mb-1">‚è±Ô∏è Durasi Kerja Hari Ini:</p>
                    <p id="durationText" class="text-2xl md:text-3xl font-bold text-blue-600">
                        0 jam 0 menit
                    </p>
                </div>
            </section>

            <section class="bg-white rounded-2xl shadow-xl p-6 lg:p-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center gap-2">
                    <span>üìä</span>
                    <span>Aktivitas Hari Ini</span>
                </h2>

                <div id="todayActivity" class="space-y-3 max-h-72 overflow-y-auto custom-scrollbar pr-2">
                    <p class="text-gray-500 text-center py-8">Belum ada aktivitas</p>
                </div>
            </section>
        </div>

    </main>

    <footer class="mt-8 text-center text-gray-600 text-sm">
        <p>&copy; 2024 PT Trakindo Utama. All rights reserved.</p>
    </footer>

</div>

<!-- JavaScript -->
<script>
    // ===================================
    // VOICE MANAGER
    // ===================================
    class VoiceManager {
        constructor() {
            this.synthesis = window.speechSynthesis;
        }

        speak(text) {
            if (!('speechSynthesis' in window)) return;
            this.synthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'id-ID';
            utterance.rate = 1.0;
            this.synthesis.speak(utterance);
        }
    }

    // ===================================
    // LOCATION MANAGER
    // ===================================
    class LocationManager {
        constructor() {
            this.currentLocation = null;
        }

        async getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation tidak didukung'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const coords = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };

                        try {
                            const address = await this.reverseGeocode(coords.latitude, coords.longitude);
                            this.currentLocation = {
                                ...coords,
                                address: address,
                                timestamp: new Date().toISOString()
                            };
                            resolve(this.currentLocation);
                        } catch (error) {
                            this.currentLocation = {
                                ...coords,
                                address: `${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}`,
                                timestamp: new Date().toISOString()
                            };
                            resolve(this.currentLocation);
                        }
                    },
                    (error) => reject(error),
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }

        async reverseGeocode(lat, lon) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`,
                    { headers: { 'Accept-Language': 'id' } }
                );

                if (!response.ok) throw new Error('Geocoding failed');

                const data = await response.json();
                const address = data.address;
                const parts = [];

                if (address.road) parts.push(address.road);
                if (address.suburb) parts.push(address.suburb);
                if (address.city || address.town) parts.push(address.city || address.town);

                return parts.length > 0 ? parts.join(', ') : data.display_name;
            } catch (error) {
                return `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
            }
        }
    }

    // ===================================
    // GLOBAL VARIABLES
    // ===================================
    let storage = null;
    let voiceManager = null;
    let locationManager = null;
    let faceMatcher = null;
    let currentUser = null;

    // ===================================
    // DOM ELEMENTS
    // ===================================
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const checkInBtn = document.getElementById('checkInBtn');
    const checkOutBtn = document.getElementById('checkOutBtn');
    const checkInTime = document.getElementById('checkInTime');
    const checkOutTime = document.getElementById('checkOutTime');
    const recognizedName = document.getElementById('recognizedName');
    const todayActivity = document.getElementById('todayActivity');
    const workDuration = document.getElementById('workDuration');
    const durationText = document.getElementById('durationText');
    const loaderContainer = document.getElementById('loader-container');
    const loaderText = document.getElementById('loader-text');
    const alertModal = document.getElementById('alertModal');
    const alertMessage = document.getElementById('alertMessage');
    const alertDetail = document.getElementById('alertDetail');
    const alertIcon = document.getElementById('alertIcon');
    const alertClose = document.getElementById('alertClose');
    const clock = document.getElementById('clock');
    const dateElement = document.getElementById('date');
    const locationText = document.getElementById('locationText');
    const locationIcon = document.getElementById('locationIcon');

    // ===================================
    // CLOCK UPDATE
    // ===================================
    function updateClock() {
        const now = new Date();
        clock.textContent = now.toLocaleTimeString('id-ID');
        dateElement.textContent = now.toLocaleDateString('id-ID', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }

    setInterval(updateClock, 1000);
    updateClock();

    // ===================================
    // SHOW ALERT
    // ===================================
    function showAlert(message, detail = '', icon = '‚úÖ') {
        alertMessage.textContent = message;
        alertDetail.textContent = detail;
        alertIcon.textContent = icon;
        alertModal.classList.remove('hidden');
        if (voiceManager) {
            voiceManager.speak(message);
        }
    }

    alertClose.addEventListener('click', () => {
        alertModal.classList.add('hidden');
    });

    // ===================================
    // UPDATE LOCATION
    // ===================================
    async function updateLocation() {
        if (!locationManager) return;
        
        try {
            locationText.textContent = 'Mendapatkan lokasi...';
            locationIcon.textContent = 'üîÑ';

            const location = await locationManager.getCurrentLocation();
            locationIcon.textContent = 'üìç';
            locationText.textContent = location.address;
        } catch (error) {
            locationIcon.textContent = '‚ùå';
            locationText.textContent = 'Lokasi tidak tersedia';
            console.error('Location error:', error);
        }
    }

    // ===================================
    // LOAD MODELS (Original approach - SIMPLE)
    // ===================================
    async function loadModels() {
        const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
        try {
            loaderText.innerText = 'Memuat model deteksi wajah...';
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);

            loaderText.innerText = 'Memuat model landmark wajah...';
            await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);

            loaderText.innerText = 'Memuat model pengenalan wajah...';
            await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);

            return true;
        } catch (error) {
            console.error("Gagal memuat model:", error);
            return false;
        }
    }

    // ===================================
    // START WEBCAM (Original - SIMPLE)
    // ===================================
    function startWebcam() {
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: { ideal: 1280 },
                height: { ideal: 720 }
            } 
        })
        .then(stream => {
            video.srcObject = stream;
        })
        .catch(err => {
            console.error("Error accessing camera:", err);
            showAlert("Tidak bisa mengakses kamera", "Pastikan Anda memberikan izin", "‚ùå");
        });
    }

    // ===================================
    // LOAD FACE MATCHER (FIXED for new format)
    // ===================================
    async function loadFaceMatcher() {
        if (!storage) {
            console.error('Storage not initialized');
            return;
        }

        try {
            const users = await storage.getUsers();
            console.log('Loaded users:', users);
            
            if (users && users.length > 0) {
                const labeledDescriptors = users.map(user => {
                    // Handle BOTH old and new format
                    let descriptors;
                    
                    if (Array.isArray(user.descriptors)) {
                        // New format: array of arrays
                        descriptors = user.descriptors.map(desc => {
                            if (desc instanceof Float32Array) {
                                return desc;
                            } else if (Array.isArray(desc)) {
                                return new Float32Array(desc);
                            } else {
                                // Old format: object with numeric keys
                                return new Float32Array(Object.values(desc));
                            }
                        });
                    } else {
                        console.warn('Unexpected descriptor format for user:', user.label);
                        return null;
                    }
                    
                    return new faceapi.LabeledFaceDescriptors(user.label, descriptors);
                }).filter(d => d !== null);
                
                faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6);
                console.log('‚úÖ Face matcher initialized with', labeledDescriptors.length, 'users');
            } else {
                console.warn('No users found in database');
                showAlert(
                    'Belum Ada Karyawan Terdaftar', 
                    'Silakan hubungi admin untuk mendaftarkan wajah Anda', 
                    '‚ö†Ô∏è'
                );
            }
        } catch (error) {
            console.error('Error loading face matcher:', error);
        }
    }

    // ===================================
    // UPDATE TODAY ACTIVITY
    // ===================================
    async function updateTodayActivity() {
        if (!currentUser || !storage) return;

        try {
            const activities = await storage.getTodayAttendance(currentUser);
            todayActivity.innerHTML = '';

            if (!activities || activities.length === 0) {
                todayActivity.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada aktivitas</p>';
                checkInTime.textContent = 'Belum absen';
                checkOutTime.textContent = 'Belum absen';
                workDuration.classList.add('hidden');
                checkInBtn.disabled = false;
                checkOutBtn.disabled = true;
                return;
            }

            const checkIn = activities.find(a => a.type === 'check-in');
            const checkOut = activities.find(a => a.type === 'check-out');

            if (checkIn) {
                const time = new Date(checkIn.timestamp).toLocaleTimeString('id-ID', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                checkInTime.textContent = time;
                checkInBtn.disabled = true;
                checkOutBtn.disabled = false;
            } else {
                checkInTime.textContent = 'Belum absen';
                checkInBtn.disabled = false;
                checkOutBtn.disabled = true;
            }

            if (checkOut) {
                const time = new Date(checkOut.timestamp).toLocaleTimeString('id-ID', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                checkOutTime.textContent = time;
                checkOutBtn.disabled = true;
            } else {
                checkOutTime.textContent = 'Belum absen';
            }

            if (checkIn && checkOut) {
                const duration = new Date(checkOut.timestamp) - new Date(checkIn.timestamp);
                const hours = Math.floor(duration / (1000 * 60 * 60));
                const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
                durationText.textContent = `${hours} jam ${minutes} menit`;
                workDuration.classList.remove('hidden');
            }

            activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            activities.forEach(activity => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg border border-gray-200 hover:shadow-md transition';

                const type = activity.type === 'check-in' ?
                    '<span class="text-green-600 font-semibold flex items-center gap-2"><span class="text-xl">üì•</span> Masuk</span>' :
                    '<span class="text-red-600 font-semibold flex items-center gap-2"><span class="text-xl">üì§</span> Pulang</span>';

                const time = new Date(activity.timestamp).toLocaleTimeString('id-ID');

                div.innerHTML = `
                    <div>${type}</div>
                    <span class="text-gray-600 text-sm font-medium">${time}</span>
                `;
                todayActivity.appendChild(div);
            });
        } catch (error) {
            console.error('Error updating today activity:', error);
        }
    }

    // ===================================
    // HANDLE ATTENDANCE
    // ===================================
    async function handleAttendance(type) {
        if (!currentUser) {
            showAlert("Wajah tidak dikenali", "Pastikan wajah Anda terlihat jelas di kamera", "‚ö†Ô∏è");
            return;
        }

        if (!storage) {
            showAlert("Sistem belum siap", "Mohon tunggu sebentar", "‚ö†Ô∏è");
            return;
        }

        if (!navigator.onLine) {
            showAlert("Mode Offline", "Fitur absensi memerlukan koneksi internet", "‚ö†Ô∏è");
            return;
        }

        try {
            const todayAttendance = await storage.getTodayAttendance(currentUser);
            const alreadyDone = todayAttendance.find(a => a.type === type);

            if (alreadyDone) {
                showAlert(
                    "Sudah melakukan absensi",
                    `Anda sudah ${type === 'check-in' ? 'masuk' : 'pulang'} hari ini`,
                    "‚ö†Ô∏è"
                );
                return;
            }

            await updateLocation();
            const location = locationManager ? locationManager.currentLocation : null;

            await storage.addAttendance({
                name: currentUser,
                type: type,
                location: location
            });

            const typeText = type === 'check-in' ? 'Masuk' : 'Pulang';
            showAlert(
                `Absensi ${typeText} Berhasil!`,
                `${currentUser} - ${new Date().toLocaleTimeString('id-ID')}`,
                type === 'check-in' ? '‚úÖ' : 'üëã'
            );

            await updateTodayActivity();
        } catch (error) {
            console.error('Error handling attendance:', error);
            showAlert("Terjadi kesalahan", "Silakan coba lagi", "‚ùå");
        }
    }

    checkInBtn.addEventListener('click', () => handleAttendance('check-in'));
    checkOutBtn.addEventListener('click', () => handleAttendance('check-out'));

    // ===================================
    // FACE DETECTION LOOP (ORIGINAL - DEFAULT OPTIONS!)
    // ===================================
    video.addEventListener('play', () => {
        const displaySize = { width: video.videoWidth, height: video.videoHeight };
        faceapi.matchDimensions(canvas, displaySize);

        let detectionInterval = 500;
        let consecutiveNoFace = 0;

        const detectFace = async () => {
            if (!faceMatcher) {
                setTimeout(detectFace, detectionInterval);
                return;
            }

            try {
                // ‚òùÔ∏è KUNCI: DEFAULT OPTIONS - No custom params!
                const detections = await faceapi
                    .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptors();

                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                let recognized = false;

                if (detections.length === 0) {
                    consecutiveNoFace++;
                    if (consecutiveNoFace > 5) {
                        detectionInterval = 1000;
                    }
                } else {
                    consecutiveNoFace = 0;
                    detectionInterval = 500;
                }

                resizedDetections.forEach(detection => {
                    const result = faceMatcher.findBestMatch(detection.descriptor);
                    const box = detection.detection.box;

                    if (result.label !== 'unknown') {
                        currentUser = result.label;
                        recognized = true;
                        recognizedName.textContent = currentUser;
                        recognizedName.className = 'text-2xl md:text-3xl font-bold text-green-600 mt-2';

                        const drawBox = new faceapi.draw.DrawBox(box, {
                            label: `${currentUser} (${Math.round((1 - result.distance) * 100)}%)`,
                            boxColor: 'green'
                        });
                        drawBox.draw(canvas);
                    } else {
                        const drawBox = new faceapi.draw.DrawBox(box, {
                            label: 'Tidak Dikenali',
                            boxColor: 'red'
                        });
                        drawBox.draw(canvas);
                    }
                });

                if (!recognized) {
                    if (currentUser !== null) {
                        currentUser = null;
                        recognizedName.textContent = 'Tidak Dikenali';
                        recognizedName.className = 'text-2xl md:text-3xl font-bold text-red-600 mt-2';
                    }
                } else {
                    updateTodayActivity();
                }
            } catch (error) {
                console.error('Face detection error:', error);
            }

            setTimeout(detectFace, detectionInterval);
        };

        detectFace();
    });

    // ===================================
    // NETWORK STATUS MONITOR
    // ===================================
    function updateNetworkStatus() {
        const networkStatus = document.getElementById('networkStatus');
        
        if (navigator.onLine) {
            networkStatus.className = 'inline-flex items-center gap-2 bg-green-100 text-green-700 px-4 py-2 rounded-full text-sm font-medium mb-4';
            networkStatus.innerHTML = '<span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span><span>Online</span>';
        } else {
            networkStatus.className = 'inline-flex items-center gap-2 bg-red-100 text-red-700 px-4 py-2 rounded-full text-sm font-medium mb-4';
            networkStatus.innerHTML = '<span class="w-2 h-2 bg-red-500 rounded-full"></span><span>Offline</span>';
        }
    }

    window.addEventListener('online', updateNetworkStatus);
    window.addEventListener('offline', updateNetworkStatus);
    updateNetworkStatus();

    // ===================================
    // INITIALIZE APPLICATION (ORIGINAL - SIMPLE)
    // ===================================
    async function initialize() {
        try {
            loaderText.innerText = 'Menginisialisasi sistem...';
            
            voiceManager = new VoiceManager();
            locationManager = new LocationManager();
            
            loaderText.innerText = 'Menghubungkan ke Firebase...';
            
            let attempts = 0;
            const maxAttempts = 20;
            
            while (typeof FirebaseStorageManager === 'undefined' && attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 500));
                attempts++;
            }
            
            if (typeof FirebaseStorageManager === 'undefined') {
                throw new Error('FirebaseStorageManager tidak ditemukan setelah ' + (maxAttempts * 500 / 1000) + ' detik');
            }
            
            storage = new FirebaseStorageManager();
            
            if (storage.waitForConnection) {
                loaderText.innerText = 'Menunggu koneksi Firebase...';
                await storage.waitForConnection();
            }
            
            const modelsLoaded = await loadModels();
            if (!modelsLoaded) {
                throw new Error('Gagal memuat model face detection');
            }
            
            loaderText.innerText = 'Memuat data wajah...';
            await loadFaceMatcher();
            
            loaderText.innerText = 'Mendapatkan lokasi...';
            updateLocation();
            
            loaderContainer.style.display = 'none';
            
            startWebcam();
            
            if (voiceManager) {
                voiceManager.speak('Sistem absensi siap digunakan');
            }
            
            console.log('‚úÖ Initialization complete');
        } catch (error) {
            console.error("‚ùå Init error:", error);
            loaderText.innerText = 'Gagal memuat sistem: ' + error.message;
            
            const retryBtn = document.createElement('button');
            retryBtn.textContent = 'Coba Lagi';
            retryBtn.className = 'mt-4 bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg';
            retryBtn.onclick = () => location.reload();
            loaderContainer.appendChild(retryBtn);
            
            showAlert('Gagal memuat sistem', error.message, '‚ùå');
        }
    }

    // ===================================
    // START (ORIGINAL - SIMPLE)
    // ===================================
    window.addEventListener('load', () => {
        setTimeout(() => {
            initialize();
        }, 500);
    });

    // ===================================
    // TOAST NOTIFICATION
    // ===================================
    function showToast(message, icon = '‚ÑπÔ∏è') {
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 transition-opacity duration-300';
        toast.innerHTML = `<span>${icon}</span><span class="text-sm">${message}</span>`;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
</script>

<!-- PWA Manager -->
<script src="/pwa-init.js"></script>

</body>
</html>
