<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Dashboard Admin - Sistem Absensi</title>

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#3b82f6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Admin Dashboard">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="description" content="Dashboard admin untuk manajemen sistem absensi karyawan">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- iOS Icons -->
  <link rel="apple-touch-icon" href="/icons/icon-152x152.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png">
  <link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png">
  <link rel="apple-touch-icon" sizes="128x128" href="/icons/icon-128x128.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png">
  <link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-72x72.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-72x72.png">

  <!-- ============================== -->
  <!-- LIBRARY CDN -->
  <!-- ============================== -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  
  <!-- ============================== -->
  <!-- üîê AUTH GUARD - LETAKKAN DI SINI -->
  <!-- ============================== -->
  <script type="module" src="./admin-auth.js"></script>
  <script type="module">
    import { waitForAdminAuth } from './admin-auth.js';

    let currentUser = null;

    // Check authentication
    waitForAdminAuth().then(user => {
      if (user) {
        currentUser = user;
        console.log('‚úÖ Admin authenticated:', user.email);
        
        // Update UI
        setTimeout(() => {
          const userEmailElement = document.getElementById('userEmail');
          if (userEmailElement) {
            userEmailElement.textContent = user.email;
          }
        }, 100);
      } else {
        console.log('‚ùå Not authenticated, redirecting to login...');
        window.location.href = 'login.html';
      }
    });

    // Monitor auth state changes
    window.adminAuth.onAuthStateChanged((user) => {
      if (!user && window.location.pathname.includes('admin.html')) {
        console.log('üîÑ Auth state changed - user logged out');
        window.location.href = 'login.html';
      }
    });

    // Logout function
    window.handleLogout = async function() {
      const modal = document.getElementById('modal');
      const modalTitle = document.getElementById('modalTitle');
      const modalContent = document.getElementById('modalContent');
      const modalConfirm = document.getElementById('modalConfirm');
      const modalCancel = document.getElementById('modalCancel');
      
      if (modal) {
        modalTitle.textContent = 'Konfirmasi Logout';
        modalContent.innerHTML = '<p class="text-gray-700">Apakah Anda yakin ingin keluar dari dashboard admin?</p>';
        modal.classList.remove('hidden');
        
        modalConfirm.onclick = async () => {
          modal.classList.add('hidden');
          
          const result = await window.adminAuth.logout();
          
          if (result.success) {
            console.log('‚úÖ Logout berhasil');
            window.location.href = 'index.html';
          } else {
            alert('Gagal logout: ' + result.error);
          }
        };
        
        modalCancel.onclick = () => {
          modal.classList.add('hidden');
        };
      }
    };

    // Export untuk digunakan di script lain
    window.getCurrentUser = () => currentUser;
    window.firebaseAuthReady = true;
  </script>
  
  <!-- ============================== -->
  <!-- Firebase Database untuk Storage -->
  <!-- ============================== -->
  <script type="module" src="firebase-config.js"></script>
  <script src="storage-firebase.js"></script>

  <!-- ============================== -->
  <!-- STYLES -->
  <!-- ============================== -->
  <style>
    .loader {
      border: 8px solid #f3f3f3;
      border-radius: 50%;
      border-top: 8px solid #3498db;
      width: 60px;
      height: 60px;
      animation: spin 2s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    .tab-active {
      background: linear-gradient(to right, #3b82f6, #6366f1);
      color: #fff;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .pulse {
      animation: pulse 2s ease-in-out infinite;
    }
  </style>
</head>

<body class="bg-gray-100">

  <!-- Loader -->
  <div id="loader-container" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col justify-center items-center z-50">
    <div class="loader"></div>
    <p id="loader-text" class="mt-4 text-lg font-semibold">Memuat dashboard...</p>
    <p id="loader-status" class="mt-2 text-sm text-gray-500">Menginisialisasi...</p>
  </div>

  <!-- Modal konfirmasi -->
  <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
      <h3 id="modalTitle" class="text-xl font-bold mb-4"></h3>
      <div id="modalContent"></div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="modalCancel" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-lg">Batal</button>
        <button id="modalConfirm" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg">OK</button>
      </div>
    </div>
  </div>

  <!-- Alert Modal -->
  <div id="alertModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
      <div id="alertIcon" class="text-6xl text-center mb-4">‚úÖ</div>
      <h3 id="alertTitle" class="text-xl font-bold mb-2 text-center"></h3>
      <p id="alertMessage" class="text-gray-600 text-center mb-4"></p>
      <div class="flex justify-center">
        <button id="alertClose" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg">OK</button>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-lg">
    <div class="container mx-auto px-4 py-6">
      <div class="flex justify-between items-center">
        <!-- Left: Title with Home Button -->
        <div class="flex items-center gap-4">
          <a href="index.html" class="text-white hover:text-blue-100 transition-colors duration-200 flex-shrink-0" title="Kembali ke Home">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
            </svg>
          </a>
          <div>
            <h1 class="text-3xl font-bold">Dashboard Admin</h1>
            <p class="text-blue-100 text-sm mt-1">Sistem Manajemen Absensi Karyawan</p>
          </div>
        </div>
        
        <!-- Right: User Info, Network Status & Logout -->
        <div class="text-right">
          <!-- Network Status -->
          <div id="networkStatusHeader" class="inline-flex items-center gap-2 bg-white bg-opacity-20 px-3 py-1 rounded-full text-xs mb-2">
            <span id="networkIconHeader" class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
            <span id="networkTextHeader">Online</span>
          </div>
          
          <div class="flex items-center gap-3 mb-2">
            <div class="text-right">
              <p class="text-sm text-blue-100">Logged in as:</p>
              <p class="text-base font-semibold" id="userEmail">Loading...</p>
            </div>
            <button 
              onclick="handleLogout()" 
              class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg text-sm transition duration-200 flex items-center gap-2"
              title="Logout dari dashboard"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
              </svg>
              <span class="hidden sm:inline">Logout</span>
            </button>
          </div>
          <p class="text-lg font-semibold" id="currentDateTime">Loading...</p>
        </div>
      </div>
    </div>
  </header>

  <!-- Navigasi -->
  <div class="bg-white shadow-md sticky top-0 z-10">
    <div class="container mx-auto px-4 flex gap-1 overflow-x-auto">
      <button class="tab px-6 py-3 rounded-t-lg tab-active" data-tab="overview">üìä Overview</button>
      <button class="tab px-6 py-3 rounded-t-lg hover:bg-gray-100" data-tab="employees">üë• Karyawan</button>
      <button class="tab px-6 py-3 rounded-t-lg hover:bg-gray-100" data-tab="attendance">üìã Data Absensi</button>
      <button class="tab px-6 py-3 rounded-t-lg hover:bg-gray-100" data-tab="reports">üìà Laporan</button>
    </div>
  </div>

  <!-- Content -->
  <div class="container mx-auto px-4 py-8">
            
    <!-- Overview Tab -->
    <div id="overview" class="tab-content">
      <!-- Statistics Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-md p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm">Total Karyawan</p>
              <p class="text-3xl font-bold text-gray-800" id="totalEmployees">0</p>
            </div>
            <span class="text-4xl">üë•</span>
          </div>
        </div>
                    
        <div class="bg-white rounded-xl shadow-md p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm">Hadir Hari Ini</p>
              <p class="text-3xl font-bold text-green-600" id="presentToday">0</p>
            </div>
            <span class="text-4xl">‚úÖ</span>
          </div>
        </div>
                    
        <div class="bg-white rounded-xl shadow-md p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm">Terlambat</p>
              <p class="text-3xl font-bold text-yellow-600" id="lateToday">0</p>
            </div>
            <span class="text-4xl">‚è∞</span>
          </div>
        </div>
                    
        <div class="bg-white rounded-xl shadow-md p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm">Tidak Hadir</p>
              <p class="text-3xl font-bold text-red-600" id="absentToday">0</p>
            </div>
            <span class="text-4xl">‚ùå</span>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl shadow-md p-6">
          <h3 class="text-xl font-bold mb-4">Statistik Mingguan</h3>
          <canvas id="weeklyChart"></canvas>
        </div>
                    
        <div class="bg-white rounded-xl shadow-md p-6">
          <h3 class="text-xl font-bold mb-4">Kehadiran Bulanan</h3>
          <canvas id="monthlyChart"></canvas>
        </div>
      </div>
    </div>

    <!-- ... (rest of the tabs remain the same) ... -->
    
  </div>

  <!-- Network Status Monitor Script -->
  <script>
    function updateNetworkStatusHeader() {
      const networkIconHeader = document.getElementById('networkIconHeader');
      const networkTextHeader = document.getElementById('networkTextHeader');
      const networkStatusHeader = document.getElementById('networkStatusHeader');
      
      if (navigator.onLine) {
        networkIconHeader.className = 'w-2 h-2 bg-green-400 rounded-full animate-pulse';
        networkTextHeader.textContent = 'Online';
        networkStatusHeader.className = 'inline-flex items-center gap-2 bg-white bg-opacity-20 px-3 py-1 rounded-full text-xs mb-2';
      } else {
        networkIconHeader.className = 'w-2 h-2 bg-red-400 rounded-full';
        networkTextHeader.textContent = 'Offline';
        networkStatusHeader.className = 'inline-flex items-center gap-2 bg-red-500 bg-opacity-90 px-3 py-1 rounded-full text-xs mb-2';
      }
    }

    window.addEventListener('online', () => {
      updateNetworkStatusHeader();
      showToast('Koneksi kembali', '‚úÖ');
    });

    window.addEventListener('offline', () => {
      updateNetworkStatusHeader();
      showToast('Mode offline - Beberapa fitur terbatas', '‚ö†Ô∏è');
    });

    updateNetworkStatusHeader();

    function showToast(message, icon = '‚ÑπÔ∏è') {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 transition-opacity duration-300';
      toast.innerHTML = `<span>${icon}</span><span class="text-sm">${message}</span>`;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
  </script>

  <!-- Main Script tetap sama seperti sebelumnya -->
  <script>
    // ... (semua script yang ada tetap sama) ...
  </script>

  <!-- PWA Service Worker Registration -->
  <script>
    // ============================================
    // üîÑ SERVICE WORKER REGISTRATION
    // ============================================
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const registration = await navigator.serviceWorker.register('/service-worker.js', {
            scope: '/'
          });
          
          console.log('‚úÖ Service Worker registered:', registration.scope);
          
          // Check for updates
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                showUpdateNotification(registration);
              }
            });
          });
          
          // Check for updates every hour
          setInterval(() => {
            registration.update();
          }, 60 * 60 * 1000);
          
        } catch (error) {
          console.error('‚ùå Service Worker registration failed:', error);
        }
      });
    }

    // ============================================
    // üîî UPDATE NOTIFICATION
    // ============================================
    function showUpdateNotification(registration) {
      const banner = document.createElement('div');
      banner.className = 'fixed top-20 right-4 bg-green-500 text-white p-4 rounded-lg shadow-2xl z-50 max-w-sm';
      banner.innerHTML = `
        <div class="flex items-center justify-between gap-4">
          <div class="flex items-center gap-3">
            <span class="text-2xl">üîÑ</span>
            <div>
              <p class="font-bold text-sm">Update Tersedia</p>
              <p class="text-xs opacity-90">Versi baru aplikasi</p>
            </div>
          </div>
          <button 
            id="update-btn" 
            class="bg-white text-green-600 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-green-50 transition">
            Update
          </button>
        </div>
      `;
      
      document.body.appendChild(banner);
      
      document.getElementById('update-btn').addEventListener('click', () => {
        if (registration.waiting) {
          registration.waiting.postMessage({ type: 'SKIP_WAITING' });
          window.location.reload();
        }
      });
    }

    // ============================================
    // üì± INSTALL PROMPT (for desktop)
    // ============================================
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // Don't show if already dismissed
      const dismissed = localStorage.getItem('pwa-install-dismissed');
      if (dismissed) {
        const hoursSince = (Date.now() - parseInt(dismissed)) / (1000 * 60 * 60);
        if (hoursSince < 168) return; // 7 days
      }
      
      // Show after 30 seconds
      setTimeout(() => {
        showInstallBanner();
      }, 30000);
    });

    function showInstallBanner() {
      const banner = document.createElement('div');
      banner.id = 'install-banner';
      banner.className = 'fixed bottom-4 right-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-4 rounded-lg shadow-2xl z-50 max-w-sm';
      banner.innerHTML = `
        <div class="flex items-center justify-between gap-4">
          <div class="flex items-center gap-3">
            <span class="text-3xl">üì±</span>
            <div>
              <p class="font-bold text-sm">Install Dashboard</p>
              <p class="text-xs opacity-90">Akses lebih cepat</p>
            </div>
          </div>
          <div class="flex gap-2">
            <button id="install-btn-admin" class="bg-white text-blue-600 px-4 py-2 rounded-lg text-sm font-semibold">
              Install
            </button>
            <button id="dismiss-btn-admin" class="text-white hover:text-blue-100">
              ‚úï
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(banner);
      
      document.getElementById('install-btn-admin').addEventListener('click', async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        deferredPrompt = null;
        banner.remove();
      });
      
      document.getElementById('dismiss-btn-admin').addEventListener('click', () => {
        localStorage.setItem('pwa-install-dismissed', Date.now());
        banner.remove();
      });
    }

    window.addEventListener('appinstalled', () => {
      console.log('‚úÖ PWA installed');
      showToast('Aplikasi berhasil diinstall! üéâ', '‚úÖ');
    });

    // Check if running as PWA
    if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
      console.log('üì± Running in standalone mode');
    }
  </script>
</body>
</html>
